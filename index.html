<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sistem Kasir - Lensa Toko</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Library untuk Scan Barcode -->
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap');
        body { font-family: 'Plus+Jakarta+Sans', sans-serif; }
        
        /* CSS Khusus Cetak Nota Thermal 58mm */
        @media print {
            @page { size: 58mm auto; margin: 0; }
            body * { visibility: hidden; }
            #printable-area, #printable-area * { visibility: visible; }
            #printable-area { 
                position: absolute; 
                left: 0; 
                top: 0; 
                width: 58mm; 
                font-family: 'Courier New', Courier, monospace; 
                font-size: 8pt; 
                padding: 1mm; 
                color: black;
                background: white;
            }
            .no-print { display: none !important; }
        }

        .tab-btn.active { background-color: #1e40af; color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* Custom scrollbar untuk kenyamanan UI */
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #bfbfbf; border-radius: 10px; }

        /* Scanner Styling */
        #reader { width: 100%; border-radius: 12px; overflow: hidden; border: none !important; }
        #reader__dashboard_section_csr button {
            background: #2563eb !important;
            color: white !important;
            padding: 6px 12px !important;
            border-radius: 6px !important;
            border: none !important;
            font-size: 11px !important;
            margin-top: 5px;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <!-- LAYER 1: SCREEN LOGIN -->
    <div id="login-screen" class="fixed inset-0 bg-blue-700 z-[200] flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-sm p-8 space-y-6">
            <div class="text-center space-y-2">
                <div class="bg-blue-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto text-blue-600 mb-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" /></svg>
                </div>
                <h2 class="text-2xl font-bold text-gray-800 tracking-tight">Lensa Toko</h2>
                <p class="text-xs text-gray-500 uppercase font-bold tracking-widest">Sistem Kasir v2.0</p>
            </div>
            <form id="login-form" class="space-y-4">
                <div>
                    <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Email Akun</label>
                    <input type="email" id="login-email" required class="w-full p-3 border rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition" placeholder="admin@lensa.toko">
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Password</label>
                    <input type="password" id="login-password" required class="w-full p-3 border rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition" placeholder="••••••••">
                </div>
                <button type="submit" id="btn-login-submit" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold hover:bg-blue-700 transition active:scale-95 shadow-lg shadow-blue-200">MASUK KE SISTEM</button>
            </form>
            <div id="login-error" class="hidden text-center text-red-500 text-xs font-semibold bg-red-50 p-2 rounded-lg border border-red-100"></div>
        </div>
    </div>

    <!-- LAYER 2: MAIN APPLICATION -->
    <div id="main-app" class="hidden">
        <!-- Top Navigation -->
        <nav class="bg-blue-600 text-white p-4 sticky top-0 z-50 shadow-md flex justify-between items-center no-print">
            <div class="flex items-center gap-2">
                <span class="font-black text-lg tracking-tighter uppercase">Lensa Toko</span>
            </div>
            <div class="flex gap-4 items-center">
                <div class="flex bg-blue-700 rounded-lg p-1 shadow-inner">
                    <button onclick="changeTab('pos')" id="tab-pos-btn" class="tab-btn active px-4 py-1.5 rounded-md text-xs font-bold transition">Kasir</button>
                    <button onclick="changeTab('history')" id="tab-history-btn" class="tab-btn px-4 py-1.5 rounded-md text-xs font-bold transition hidden">Riwayat</button>
                    <button onclick="changeTab('inventory')" id="tab-inventory-btn" class="tab-btn px-4 py-1.5 rounded-md text-xs font-bold transition hidden">Stok</button>
                </div>
                <div class="flex items-center gap-3">
                    <span id="user-display" class="text-[10px] font-bold bg-blue-800 px-2 py-1 rounded hidden md:block"></span>
                    <button onclick="logout()" class="p-2 bg-red-500/20 hover:bg-red-500 rounded-lg transition" title="Logout">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>
                    </button>
                </div>
            </div>
        </nav>

        <main class="max-w-7xl mx-auto p-4 pb-24 no-print">
            
            <!-- Global Scanner Camera Container -->
            <div id="scanner-container" class="hidden bg-black rounded-2xl overflow-hidden shadow-2xl mb-6 border-4 border-white">
                <div id="reader"></div>
            </div>

            <!-- TAB: KASIR (POS) -->
            <div id="pos" class="tab-content active">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    
                    <!-- Search & Products (Left Side) -->
                    <div class="lg:col-span-2 space-y-4">
                        <div class="bg-white p-5 rounded-2xl shadow-sm border space-y-4">
                            <div class="flex flex-wrap items-center justify-between gap-4">
                                <!-- Mode Selector -->
                                <div class="flex items-center gap-1 bg-gray-100 p-1 rounded-xl border">
                                    <button onclick="setSaleMode('ecer')" id="mode-ecer-btn" class="px-5 py-2.5 rounded-lg text-[10px] font-black transition bg-blue-600 text-white shadow-sm">MODE ECERAN</button>
                                    <button onclick="setSaleMode('grosir')" id="mode-grosir-btn" class="px-5 py-2.5 rounded-lg text-[10px] font-black transition text-gray-500 hover:text-blue-600">MODE GROSIR</button>
                                </div>
                                <!-- Scanner Toggle -->
                                <button onclick="toggleScanner('pos')" class="flex items-center gap-2 bg-blue-50 text-blue-600 px-5 py-2.5 rounded-xl font-bold text-xs hover:bg-blue-100 transition border border-blue-100 shadow-sm">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z" /></svg>
                                    SCAN BARCODE
                                </button>
                            </div>

                            <!-- Search Input -->
                            <div class="relative">
                                <span class="absolute inset-y-0 left-4 flex items-center text-gray-400">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                                </span>
                                <input type="text" id="search-input" placeholder="Cari nama barang atau scan barcode..." class="w-full pl-12 pr-4 py-4 rounded-2xl border border-gray-200 outline-none focus:ring-4 focus:ring-blue-500/10 focus:border-blue-500 transition shadow-inner bg-gray-50" oninput="filterDisplay()">
                            </div>
                        </div>

                        <!-- Product Display Grid -->
                        <div id="product-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3 overflow-y-auto max-h-[60vh] custom-scroll">
                            <!-- Items populated via JS -->
                        </div>
                    </div>

                    <!-- Cart & Summary (Right Side) -->
                    <div class="bg-white rounded-3xl shadow-xl flex flex-col h-[calc(100vh-140px)] sticky top-20 border border-gray-100 overflow-hidden">
                        <div class="p-5 border-b space-y-4 bg-gray-50/50">
                            <div class="flex justify-between items-center">
                                <h2 class="font-bold text-gray-800 text-xs uppercase tracking-widest">Daftar Belanja</h2>
                                <button onclick="emptyCart()" class="text-[10px] font-black text-red-500 hover:bg-red-50 px-2 py-1 rounded transition">KOSONGKAN</button>
                            </div>
                            <!-- Customer Input -->
                            <div class="relative">
                                <span class="absolute inset-y-0 left-3 flex items-center text-gray-400">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
                                </span>
                                <input type="text" id="customer-name" placeholder="Nama Pelanggan (Umum)" class="w-full text-xs pl-9 pr-3 py-3 border rounded-xl outline-none focus:border-blue-500 bg-white shadow-sm transition">
                            </div>
                        </div>

                        <!-- Cart Items List -->
                        <div id="cart-list" class="flex-grow overflow-y-auto p-5 space-y-4 custom-scroll">
                            <div class="text-center text-gray-300 mt-20 flex flex-col items-center opacity-50">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" /></svg>
                                <p class="text-sm font-bold">Keranjang Kosong</p>
                            </div>
                        </div>

                        <!-- Checkout Footer -->
                        <div class="p-6 bg-blue-600 text-white space-y-4 shadow-[0_-10px_20px_rgba(0,0,0,0.05)]">
                            <div class="flex justify-between items-center">
                                <span class="text-blue-100 text-xs font-bold uppercase tracking-wider">Total Tagihan</span>
                                <span class="text-2xl font-black" id="grand-total">Rp 0</span>
                            </div>
                            <button onclick="openPayment()" class="w-full bg-white text-blue-700 hover:bg-blue-50 py-4 rounded-2xl font-black shadow-xl transition active:scale-95 uppercase tracking-widest text-sm">
                                PROSES PEMBAYARAN
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB: RIWAYAT (HISTORY) -->
            <div id="history" class="tab-content">
                <div class="bg-white rounded-3xl shadow-xl border border-gray-100 overflow-hidden">
                    <div class="p-6 border-b bg-gray-50 flex justify-between items-center">
                        <h2 class="font-bold text-xl text-gray-800 tracking-tight">Riwayat Transaksi</h2>
                        <button onclick="getTransactions()" class="p-2 bg-blue-50 text-blue-600 rounded-xl hover:bg-blue-100 transition">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
                        </button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-gray-50 text-[10px] font-black uppercase text-gray-400 tracking-widest border-b border-gray-100">
                                <tr>
                                    <th class="p-5">Waktu</th>
                                    <th class="p-5">Pelanggan</th>
                                    <th class="p-5 text-right">Total</th>
                                    <th class="p-5">Kasir</th>
                                    <th class="p-5 text-center">Tindakan</th>
                                </tr>
                            </thead>
                            <tbody id="history-table-body" class="text-xs divide-y divide-gray-50">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- TAB: STOK (INVENTORY) - ADMIN ONLY -->
            <div id="inventory" class="tab-content">
                <div class="bg-white rounded-3xl shadow-sm p-8 mb-6 border border-gray-100">
                    <div class="flex items-center gap-3 mb-6">
                        <div class="bg-blue-100 p-2 rounded-xl text-blue-600">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" /></svg>
                        </div>
                        <h2 class="font-bold text-xl text-gray-800 tracking-tight">Master Data Produk</h2>
                    </div>

                    <form id="product-form" class="grid grid-cols-1 md:grid-cols-6 gap-6">
                        <input type="hidden" id="edit-id">
                        
                        <div class="md:col-span-3">
                            <label class="text-[10px] font-black text-gray-400 uppercase tracking-widest mb-1 block">Nama Produk</label>
                            <input type="text" id="p-nama" required class="w-full p-3 border-2 border-gray-100 rounded-xl outline-none focus:border-blue-500 transition bg-gray-50">
                        </div>
                        <div class="md:col-span-2">
                            <label class="text-[10px] font-black text-gray-400 uppercase tracking-widest mb-1 block">Barcode (Opsional)</label>
                            <div class="flex gap-2">
                                <input type="text" id="p-barcode" class="w-full p-3 border-2 border-gray-100 rounded-xl outline-none focus:border-blue-500 transition bg-gray-50" placeholder="Scan/ketik manual">
                                <button type="button" onclick="toggleScanner('inventory')" class="bg-blue-600 text-white p-3 rounded-xl hover:bg-blue-700 transition shadow-lg shadow-blue-100">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z" /></svg>
                                </button>
                            </div>
                        </div>
                        <div>
                            <label class="text-[10px] font-black text-gray-400 uppercase tracking-widest mb-1 block">Stok Utama</label>
                            <input type="number" id="p-stok" required class="w-full p-3 border-2 border-gray-100 rounded-xl outline-none focus:border-blue-500 transition bg-gray-50">
                        </div>

                        <!-- 4 MULTI-UNIT CONFIGURATION -->
                        <div class="md:col-span-6 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                            <!-- Unit 1 (Required) -->
                            <div class="bg-blue-50/50 p-5 rounded-2xl border-2 border-blue-100 space-y-4">
                                <div class="font-black text-blue-700 text-[10px] uppercase tracking-widest">Unit 1 (Terkecil - Wajib)</div>
                                <div class="space-y-3">
                                    <input type="text" id="p-satuan-1" required class="w-full p-2.5 border rounded-lg text-sm font-bold" placeholder="Nama: Pcs">
                                    <div>
                                        <label class="text-[9px] text-gray-500 font-bold uppercase">Harga Eceran</label>
                                        <input type="number" id="p-ecer-1" required class="w-full p-2 border rounded-lg text-sm">
                                    </div>
                                    <div>
                                        <label class="text-[9px] text-gray-500 font-bold uppercase">Harga Grosir</label>
                                        <input type="number" id="p-grosir-1" required class="w-full p-2 border rounded-lg text-sm">
                                    </div>
                                </div>
                            </div>
                            <!-- Unit 2 (Optional) -->
                            <div class="bg-gray-50 p-5 rounded-2xl border-2 border-gray-100 space-y-4">
                                <div class="font-black text-gray-500 text-[10px] uppercase tracking-widest">Unit 2 (Opsional)</div>
                                <div class="space-y-3">
                                    <input type="text" id="p-satuan-2" class="w-full p-2.5 border rounded-lg text-sm font-bold" placeholder="Nama: Pak">
                                    <div>
                                        <label class="text-[9px] text-gray-400 font-bold uppercase">Harga Eceran</label>
                                        <input type="number" id="p-ecer-2" class="w-full p-2 border rounded-lg text-sm">
                                    </div>
                                    <div>
                                        <label class="text-[9px] text-gray-400 font-bold uppercase">Harga Grosir</label>
                                        <input type="number" id="p-grosir-2" class="w-full p-2 border rounded-lg text-sm">
                                    </div>
                                </div>
                            </div>
                            <!-- Unit 3 (Optional) -->
                            <div class="bg-gray-50 p-5 rounded-2xl border-2 border-gray-100 space-y-4">
                                <div class="font-black text-gray-500 text-[10px] uppercase tracking-widest">Unit 3 (Opsional)</div>
                                <div class="space-y-3">
                                    <input type="text" id="p-satuan-3" class="w-full p-2.5 border rounded-lg text-sm font-bold" placeholder="Nama: Dus">
                                    <div>
                                        <label class="text-[9px] text-gray-400 font-bold uppercase">Harga Eceran</label>
                                        <input type="number" id="p-ecer-3" class="w-full p-2 border rounded-lg text-sm">
                                    </div>
                                    <div>
                                        <label class="text-[9px] text-gray-400 font-bold uppercase">Harga Grosir</label>
                                        <input type="number" id="p-grosir-3" class="w-full p-2 border rounded-lg text-sm">
                                    </div>
                                </div>
                            </div>
                            <!-- Unit 4 (Optional) -->
                            <div class="bg-gray-50 p-5 rounded-2xl border-2 border-gray-100 space-y-4">
                                <div class="font-black text-gray-500 text-[10px] uppercase tracking-widest">Unit 4 (Opsional)</div>
                                <div class="space-y-3">
                                    <input type="text" id="p-satuan-4" class="w-full p-2.5 border rounded-lg text-sm font-bold" placeholder="Nama: Bal">
                                    <div>
                                        <label class="text-[9px] text-gray-400 font-bold uppercase">Harga Eceran</label>
                                        <input type="number" id="p-ecer-4" class="w-full p-2 border rounded-lg text-sm">
                                    </div>
                                    <div>
                                        <label class="text-[9px] text-gray-400 font-bold uppercase">Harga Grosir</label>
                                        <input type="number" id="p-grosir-4" class="w-full p-2 border rounded-lg text-sm">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="md:col-span-6 flex gap-3 pt-6 border-t">
                            <button type="submit" class="bg-blue-600 text-white px-10 py-4 rounded-2xl font-black hover:bg-blue-700 transition flex-grow shadow-lg shadow-blue-200 uppercase tracking-widest text-sm">
                                SIMPAN DATA BARANG
                            </button>
                            <button type="button" onclick="resetForm()" class="bg-gray-100 text-gray-500 px-8 py-4 rounded-2xl font-bold hover:bg-gray-200 transition">BATAL</button>
                        </div>
                    </form>
                </div>
                
                <!-- Inventory List Table -->
                <div class="bg-white rounded-3xl shadow-xl border border-gray-100 overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-gray-50 text-[10px] font-black uppercase text-gray-400 tracking-widest border-b border-gray-100">
                                <tr>
                                    <th class="p-5">Informasi Produk</th>
                                    <th class="p-5 text-center">Stok</th>
                                    <th class="p-5">Harga Unit 1 (Min)</th>
                                    <th class="p-5">Harga Unit 2</th>
                                    <th class="p-5 text-center">Tindakan</th>
                                </tr>
                            </thead>
                            <tbody id="inventory-table-body" class="text-xs divide-y divide-gray-50">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- MODAL: PEMBAYARAN & CASHFLOW -->
    <div id="pay-modal" class="fixed inset-0 bg-black/70 hidden z-[300] flex items-center justify-center p-4 backdrop-blur-md">
        <div class="bg-white rounded-[2.5rem] w-full max-w-md p-10 space-y-8 shadow-2xl animate-in zoom-in-95 duration-200">
            <div class="text-center space-y-1">
                <p class="text-gray-400 font-black text-[10px] uppercase tracking-[0.2em]">Total Tagihan Akhir</p>
                <h3 class="font-black text-5xl text-blue-600" id="modal-total">Rp 0</h3>
            </div>
            
            <div class="space-y-3">
                <label class="block text-center text-xs font-black text-gray-400 uppercase tracking-widest">Tunai Yang Diterima</label>
                <input type="number" id="cash-input" oninput="calcChange()" class="w-full text-5xl font-black p-6 border-4 border-gray-50 rounded-3xl text-center outline-none focus:border-blue-500 transition bg-gray-50/50 shadow-inner" placeholder="0">
            </div>

            <div class="flex justify-between items-center p-6 bg-green-50 rounded-3xl border border-green-100">
                <div class="space-y-0.5">
                    <span class="text-green-700 font-black text-[10px] uppercase tracking-widest opacity-60">Uang Kembali</span>
                    <div id="change-display" class="font-black text-3xl text-green-700">Rp 0</div>
                </div>
                <div class="bg-green-200/50 p-2 rounded-full text-green-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 4a2 2 0 00-2 2v4a2 2 0 002 2V6h10a2 2 0 00-2-2H4zm2 6a2 2 0 012-2h8a2 2 0 012 2v4a2 2 0 01-2 2H8a2 2 0 01-2-2v-4zm6 4a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"/></svg>
                </div>
            </div>

            <div class="flex gap-4 pt-2">
                <button onclick="closePayment()" class="flex-1 py-5 font-black text-gray-400 hover:text-gray-600 transition uppercase tracking-widest text-xs">BATAL</button>
                <button onclick="processCheckout()" id="btn-final" class="flex-[2.5] py-5 bg-green-600 text-white rounded-3xl font-black shadow-2xl shadow-green-200 disabled:opacity-20 disabled:shadow-none transition active:scale-95 uppercase tracking-widest text-xs" disabled>CETAK STRUK</button>
            </div>
        </div>
    </div>

    <!-- MODAL: DETAIL TRANSAKSI RIWAYAT -->
    <div id="history-modal" class="fixed inset-0 bg-black/70 hidden z-[400] flex items-center justify-center p-4 backdrop-blur-md">
        <div class="bg-white rounded-[2rem] w-full max-w-lg p-8 space-y-6 shadow-2xl">
            <div class="flex justify-between items-center">
                <h3 class="font-bold text-xl text-gray-800">Detail Transaksi</h3>
                <button onclick="closeHistoryModal()" class="text-gray-400 hover:text-gray-600">✕</button>
            </div>
            <div id="history-detail-content" class="space-y-4 text-sm max-h-[50vh] overflow-y-auto custom-scroll pr-2">
                <!-- Detailed items here -->
            </div>
            <div class="flex gap-3 pt-4 border-t">
                <button onclick="closeHistoryModal()" class="flex-1 py-3 font-bold text-gray-500 bg-gray-100 rounded-xl hover:bg-gray-200 transition">TUTUP</button>
                <button id="reprint-btn" class="flex-[2] py-3 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 transition shadow-lg shadow-blue-100">CETAK ULANG STRUK</button>
            </div>
        </div>
    </div>

    <!-- STRUK BELANJA (VISIBLE ONLY DURING PRINT) -->
    <div id="printable-area" class="hidden">
        <div style="text-align:center; margin-bottom: 10px;">
            <b style="font-size: 11pt;">LENSA TOKO</b><br>
            <span style="font-size: 8pt;">Jl. Raya Grosir No. 12, Bekasi</span><br>
            <span style="font-size: 8pt;">WA: 0812-XXXX-XXXX</span><br>
            ================================
        </div>
        <div id="print-info" style="font-size: 7pt; line-height: 1.4; margin-bottom: 8px;"></div>
        <div style="border-bottom: 1px dashed black; margin-bottom: 8px;"></div>
        <table style="width: 100%; font-size: 7.5pt; border-collapse: collapse;" id="print-items-table">
            <!-- Items rendered here -->
        </table>
        <div style="border-top: 1px dashed black; margin-top: 8px; padding-top: 5px;">
            <div style="display:flex; justify-content:space-between; font-weight: bold; font-size: 9pt;">
                <span>TOTAL:</span><span id="print-total"></span>
            </div>
            <div style="display:flex; justify-content:space-between; font-size: 7pt; margin-top: 3px;">
                <span>TUNAI:</span><span id="print-cash"></span>
            </div>
            <div style="display:flex; justify-content:space-between; font-size: 7pt;">
                <span>KEMBALI:</span><span id="print-change"></span>
            </div>
        </div>
        <div style="text-align:center; margin-top: 15px; font-size: 7pt; border-top: 1px dashed black; padding-top: 8px; line-height: 1.4;">
            Terima Kasih Atas Kunjungan Anda!<br>
            Barang yang sudah dibeli<br>tidak dapat dikembalikan.
        </div>
    </div>

    <script>
        // CONFIGURASI SUPABASE
        const SUPABASE_URL = "https://aafacwvmzxzpyyxryuoc.supabase.co";
        const SUPABASE_KEY = "sb_publishable_ARHLAIm1BNBWUTGBqfX8zA_OYlZHB9-"; 
        
        let SESSION_TOKEN = localStorage.getItem('lensa_token') || "";
        let USER_EMAIL = localStorage.getItem('lensa_email') || "";
        
        let allProducts = [];
        let cart = [];
        let totalBelanja = 0;
        let currentSaleMode = 'ecer'; // 'ecer' or 'grosir'
        let html5QrCode = null;
        let currentScannerMode = 'pos'; // 'pos' or 'inventory'

        function getHeaders() {
            return {
                "apikey": SUPABASE_KEY,
                "Authorization": `Bearer ${SESSION_TOKEN || SUPABASE_KEY}`,
                "Content-Type": "application/json",
                "Prefer": "return=representation"
            };
        }

        // --- AUTH SYSTEM ---
        document.getElementById('login-form').onsubmit = async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const errorEl = document.getElementById('login-error');
            const btn = document.getElementById('btn-login-submit');

            btn.innerText = "MEMVERIFIKASI...";
            btn.disabled = true;

            try {
                const res = await fetch(`${SUPABASE_URL}/auth/v1/token?grant_type=password`, {
                    method: 'POST',
                    headers: { "apikey": SUPABASE_KEY, "Content-Type": "application/json" },
                    body: JSON.stringify({ email, password })
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.error_description || "Login gagal");

                SESSION_TOKEN = data.access_token;
                USER_EMAIL = data.user.email;
                localStorage.setItem('lensa_token', SESSION_TOKEN);
                localStorage.setItem('lensa_email', USER_EMAIL);
                checkAuth();
            } catch (err) {
                errorEl.innerText = "Login Gagal. Email/Password salah.";
                errorEl.classList.remove('hidden');
            } finally {
                btn.innerText = "MASUK KE SISTEM";
                btn.disabled = false;
            }
        };

        function checkAuth() {
            if (SESSION_TOKEN && USER_EMAIL) {
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('main-app').classList.remove('hidden');
                
                const userDisplay = document.getElementById('user-display');
                userDisplay.innerText = USER_EMAIL;
                userDisplay.classList.remove('hidden');

                // Role Logic: Hanya admin@lensa.toko yang bisa lihat tab stok dan riwayat
                const isAdmin = USER_EMAIL === 'admin@lensa.toko';
                document.getElementById('tab-inventory-btn').classList.toggle('hidden', !isAdmin);
                document.getElementById('tab-history-btn').classList.toggle('hidden', !isAdmin);

                init();
            } else {
                document.getElementById('login-screen').classList.remove('hidden');
            }
        }

        function logout() { localStorage.clear(); location.reload(); }

        // --- APP CORE ---
        async function init() { await getProducts(); }

        async function getProducts() {
            try {
                const res = await fetch(`${SUPABASE_URL}/rest/v1/barang?select=*&order=nama.asc`, { headers: getHeaders() });
                if (res.status === 401 || res.status === 403) return logout();
                allProducts = await res.json();
                renderPOS(allProducts);
                if (USER_EMAIL === 'admin@lensa.toko') renderInventoryTable();
            } catch (err) { console.error("Fetch Error:", err); }
        }

        function changeTab(tab) {
            if (tab === 'inventory' && USER_EMAIL !== 'admin@lensa.toko') return;
            if (tab === 'history' && USER_EMAIL !== 'admin@lensa.toko') return;
            
            stopScanner();
            document.getElementById('scanner-container').classList.add('hidden');

            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(tab).classList.add('active');
            document.getElementById(`tab-${tab}-btn`).classList.add('active');
            
            if (tab === 'inventory') getProducts();
            if (tab === 'history') getTransactions();
        }

        function setSaleMode(mode) {
            currentSaleMode = mode;
            document.getElementById('mode-ecer-btn').className = mode === 'ecer' ? "px-5 py-2.5 rounded-lg text-[10px] font-black transition bg-blue-600 text-white shadow-sm" : "px-5 py-2.5 rounded-lg text-[10px] font-black transition text-gray-500 hover:text-blue-600";
            document.getElementById('mode-grosir-btn').className = mode === 'grosir' ? "px-5 py-2.5 rounded-lg text-[10px] font-black transition bg-blue-600 text-white shadow-sm" : "px-5 py-2.5 rounded-lg text-[10px] font-black transition text-gray-500 hover:text-blue-600";
            
            cart = cart.map(item => {
                const p = allProducts.find(x => x.id === item.id);
                const price = p[`harga_${currentSaleMode}_${item.unitType}`];
                return { ...item, price };
            });
            updateCartUI();
        }

        // --- SCANNER LOGIC ---
        function toggleScanner(mode = 'pos') {
            currentScannerMode = mode;
            const container = document.getElementById('scanner-container');
            
            if (container.classList.contains('hidden')) {
                container.classList.remove('hidden');
                startScanner();
            } else {
                stopScanner();
                container.classList.add('hidden');
            }
        }

        function startScanner() {
            if (html5QrCode) html5QrCode.clear();
            
            html5QrCode = new Html5Qrcode("reader");
            const config = { 
                fps: 15, 
                qrbox: { width: 250, height: 150 }, 
                formatsToSupport: [ 
                    Html5QrcodeSupportedFormats.CODE_128, 
                    Html5QrcodeSupportedFormats.EAN_13, 
                    Html5QrcodeSupportedFormats.EAN_8,
                    Html5QrcodeSupportedFormats.UPC_A
                ] 
            };
            
            html5QrCode.start({ facingMode: "environment" }, config, (decodedText) => {
                if (currentScannerMode === 'pos') {
                    const p = allProducts.find(x => x.barcode === decodedText);
                    if (p) {
                        addToCart(p.id);
                        if (navigator.vibrate) navigator.vibrate(100);
                    }
                } else {
                    document.getElementById('p-barcode').value = decodedText;
                    if (navigator.vibrate) navigator.vibrate(100);
                    toggleScanner('inventory');
                }
            }).catch(e => {
                console.error("Gagal memulai kamera:", e);
                document.getElementById('scanner-container').classList.add('hidden');
            });
        }

        function stopScanner() {
            if (html5QrCode) {
                const state = html5QrCode.getState();
                if (state === 2 || state === 3) {
                    html5QrCode.stop().then(() => {
                        html5QrCode.clear();
                        html5QrCode = null;
                    }).catch(err => {
                        console.warn("Gagal menghentikan scanner secara bersih:", err);
                        html5QrCode = null;
                    });
                } else {
                    html5QrCode.clear();
                    html5QrCode = null;
                }
            }
        }

        // --- POS FUNCTIONS ---
        function filterDisplay() {
            const val = document.getElementById('search-input').value.toLowerCase();
            const bMatch = allProducts.find(p => p.barcode === val);
            if (bMatch && val.length >= 4) {
                addToCart(bMatch.id);
                document.getElementById('search-input').value = "";
                return;
            }
            const filtered = allProducts.filter(p => p.nama.toLowerCase().includes(val));
            renderPOS(filtered);
        }

        function renderPOS(items) {
            const container = document.getElementById('product-grid');
            if (items.length === 0) {
                container.innerHTML = `<div class="col-span-full p-10 text-center text-gray-300">Barang tidak ditemukan</div>`;
                return;
            }
            container.innerHTML = items.map(p => {
                const price = p[`harga_${currentSaleMode}_1`];
                return `
                <div onclick="addToCart(${p.id})" class="bg-white p-4 rounded-2xl shadow-sm border border-transparent hover:border-blue-500 hover:shadow-md transition cursor-pointer active:scale-95 group">
                    <div class="flex flex-col h-full justify-between">
                        <div class="space-y-1">
                            <span class="text-[7px] font-black text-blue-500 uppercase tracking-tighter">${p.satuan_1}</span>
                            <h3 class="font-bold text-xs text-gray-800 line-clamp-2 leading-tight group-hover:text-blue-600 transition">${p.nama}</h3>
                        </div>
                        <div class="mt-3 pt-3 border-t border-gray-50 flex justify-between items-center">
                            <div class="text-[9px] text-gray-400">Stok: ${p.stok}</div>
                            <div class="font-black text-sm text-gray-900">Rp ${Number(price).toLocaleString()}</div>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }

        function addToCart(pid) {
            const prod = allProducts.find(x => x.id === pid);
            if (!prod || prod.stok <= 0) return alert("Maaf, stok barang habis!");
            
            const unitType = 1;
            const existing = cart.find(c => c.id === pid && c.unitType === unitType);
            const price = prod[`harga_${currentSaleMode}_${unitType}`];
            const unitName = prod[`satuan_${unitType}`];

            if (existing) {
                existing.qty++;
            } else {
                cart.push({ id: prod.id, nama: prod.nama, qty: 1, price, unitType, unitName });
            }
            updateCartUI();
        }

        function editUnit(idx, type) {
            const item = cart[idx];
            const p = allProducts.find(x => x.id === item.id);
            const unitType = parseInt(type);
            
            item.unitType = unitType;
            item.unitName = p[`satuan_${unitType}`];
            item.price = p[`harga_${currentSaleMode}_${unitType}`];
            updateCartUI();
        }

        function updateQtyManual(idx, val) {
            const n = parseInt(val);
            if (isNaN(n) || n <= 0) return removeFromCart(idx);
            cart[idx].qty = n;
            updateCartUI();
        }

        function updateCartUI() {
            const list = document.getElementById('cart-list');
            if (cart.length === 0) {
                list.innerHTML = `<div class="text-center text-gray-300 mt-20 flex flex-col items-center opacity-50"><svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" /></svg><p class="text-sm font-bold">Keranjang Kosong</p></div>`;
                totalBelanja = 0;
                document.getElementById('grand-total').innerText = 'Rp 0';
                return;
            }

            let grand = 0;
            list.innerHTML = cart.map((item, idx) => {
                const sub = item.price * item.qty;
                grand += sub;
                
                const p = allProducts.find(x => x.id === item.id);
                let unitOptions = "";
                for(let i=1; i<=4; i++) {
                    const sName = p[`satuan_${i}`];
                    if(sName) unitOptions += `<option value="${i}" ${item.unitType === i ? 'selected' : ''}>${sName}</option>`;
                }

                return `
                <div class="bg-white p-4 rounded-2xl border-2 border-gray-50 relative shadow-sm hover:border-blue-100 transition">
                    <button onclick="removeFromCart(${idx})" class="absolute top-2 right-2 text-gray-300 hover:text-red-500 transition p-1">✕</button>
                    <div class="flex justify-between items-start pr-6">
                        <div class="space-y-1">
                            <h4 class="font-bold text-[11px] leading-tight text-gray-800 pr-2">${item.nama}</h4>
                            <span class="text-[8px] font-black text-blue-600 bg-blue-50 px-1.5 py-0.5 rounded uppercase tracking-tighter">${currentSaleMode}</span>
                        </div>
                        <div class="text-right">
                             <div class="font-black text-xs text-gray-900">Rp ${sub.toLocaleString()}</div>
                        </div>
                    </div>
                    <div class="flex items-center gap-3 mt-3 pt-3 border-t border-gray-50">
                        <div class="flex-grow">
                            <select onchange="editUnit(${idx}, this.value)" class="w-full text-[10px] p-2 border rounded-xl bg-gray-50 font-black outline-none focus:border-blue-500 shadow-sm cursor-pointer">
                                ${unitOptions}
                            </select>
                        </div>
                        <div class="flex items-center gap-2">
                            <label class="text-[9px] font-black text-gray-400 uppercase">Qty:</label>
                            <input type="number" value="${item.qty}" onchange="updateQtyManual(${idx}, this.value)" class="w-16 p-2 border rounded-xl font-black text-xs text-center outline-none focus:border-blue-500 bg-gray-50 shadow-sm">
                        </div>
                    </div>
                </div>`;
            }).join('');
            
            totalBelanja = grand;
            document.getElementById('grand-total').innerText = `Rp ${grand.toLocaleString()}`;
        }

        function removeFromCart(idx) { cart.splice(idx, 1); updateCartUI(); }
        function emptyCart() { if(confirm("Bersihkan keranjang belanja?")) { cart = []; updateCartUI(); } }

        // --- PAYMENT & CHECKOUT ---
        function openPayment() {
            if (cart.length === 0) return;
            document.getElementById('modal-total').innerText = `Rp ${totalBelanja.toLocaleString()}`;
            document.getElementById('cash-input').value = '';
            document.getElementById('change-display').innerText = 'Rp 0';
            document.getElementById('pay-modal').classList.remove('hidden');
            setTimeout(() => document.getElementById('cash-input').focus(), 300);
        }

        function closePayment() { document.getElementById('pay-modal').classList.add('hidden'); }

        function calcChange() {
            const cash = parseFloat(document.getElementById('cash-input').value) || 0;
            const kembalian = cash - totalBelanja;
            document.getElementById('change-display').innerText = `Rp ${Math.max(0, kembalian).toLocaleString()}`;
            document.getElementById('btn-final').disabled = cash < totalBelanja;
        }

        async function processCheckout() {
            const btn = document.getElementById('btn-final');
            const cust = document.getElementById('customer-name').value || "Umum";
            btn.innerText = "MENYIMPAN...";
            btn.disabled = true;

            try {
                const resTx = await fetch(`${SUPABASE_URL}/rest/v1/transaksi`, { 
                    method: 'POST', 
                    headers: getHeaders(), 
                    body: JSON.stringify({ total: totalBelanja, nama_pelanggan: cust, user_email: USER_EMAIL }) 
                });
                const txData = await resTx.json();
                const txId = txData[0].id;

                for (const item of cart) {
                    await fetch(`${SUPABASE_URL}/rest/v1/transaksi_detail`, { 
                        method: 'POST', 
                        headers: getHeaders(), 
                        body: JSON.stringify({ transaksi_id: txId, barang_id: item.id, qty: item.qty, harga: item.price, satuan_digunakan: item.unitName }) 
                    });
                    const p = allProducts.find(x => x.id === item.id);
                    await fetch(`${SUPABASE_URL}/rest/v1/barang?id=eq.${item.id}`, { 
                        method: 'PATCH', 
                        headers: getHeaders(), 
                        body: JSON.stringify({ stok: p.stok - item.qty }) 
                    });
                }

                const cash = parseFloat(document.getElementById('cash-input').value);
                const info = {
                    date: new Date().toLocaleString('id-ID'),
                    kasir: USER_EMAIL.split('@')[0],
                    customer: cust,
                    total: totalBelanja,
                    cash: cash,
                    change: cash - totalBelanja,
                    items: [...cart]
                };
                
                printReceipt(info);
                
                cart = [];
                updateCartUI();
                closePayment();
                document.getElementById('customer-name').value = "";
                await getProducts();
                alert("Transaksi Berhasil!");

            } catch (err) {
                alert("Terjadi kesalahan teknis saat menyimpan transaksi.");
            } finally {
                btn.innerText = "CETAK STRUK";
                btn.disabled = false;
            }
        }

        function printReceipt(info) {
            document.getElementById('print-info').innerHTML = `
                Tgl  : ${info.date}<br>
                Kasir: ${info.kasir}<br>
                Plgn : ${info.customer}
            `;
            document.getElementById('print-total').innerText = "Rp " + info.total.toLocaleString();
            document.getElementById('print-cash').innerText = "Rp " + info.cash.toLocaleString();
            document.getElementById('print-change').innerText = "Rp " + info.change.toLocaleString();
            
            document.getElementById('print-items-table').innerHTML = info.items.map(item => `
                <tr>
                    <td colspan="2" style="padding-top: 5px;">${item.nama}</td>
                </tr>
                <tr>
                    <td style="color: #666;">${item.qty} ${item.unitName} x ${item.price.toLocaleString()}</td>
                    <td style="text-align: right;">${(item.price * item.qty).toLocaleString()}</td>
                </tr>
            `).join('');

            window.print();
        }

        // --- HISTORY FUNCTIONS ---
        async function getTransactions() {
            const tbody = document.getElementById('history-table-body');
            tbody.innerHTML = `<tr><td colspan="5" class="p-10 text-center animate-pulse">Memuat data transaksi...</td></tr>`;
            
            try {
                const res = await fetch(`${SUPABASE_URL}/rest/v1/transaksi?select=*&order=tanggal.desc`, { headers: getHeaders() });
                const data = await res.json();
                
                if (data.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="5" class="p-10 text-center text-gray-400">Belum ada data transaksi</td></tr>`;
                    return;
                }

                tbody.innerHTML = data.map(tx => `
                    <tr class="hover:bg-gray-50 transition">
                        <td class="p-5 font-bold text-gray-700">${new Date(tx.tanggal).toLocaleString('id-ID', { dateStyle: 'short', timeStyle: 'short' })}</td>
                        <td class="p-5">${tx.nama_pelanggan}</td>
                        <td class="p-5 text-right font-black text-blue-600">Rp ${Number(tx.total).toLocaleString()}</td>
                        <td class="p-5 text-gray-400 font-bold">${tx.user_email?.split('@')[0] || '-'}</td>
                        <td class="p-5 text-center">
                            <button onclick="viewTransactionDetail(${tx.id})" class="bg-white border-2 border-blue-500 text-blue-600 px-3 py-1.5 rounded-xl font-bold hover:bg-blue-600 hover:text-white transition text-[10px] uppercase">Detail</button>
                        </td>
                    </tr>
                `).join('');
            } catch (err) {
                tbody.innerHTML = `<tr><td colspan="5" class="p-10 text-center text-red-500">Gagal memuat data riwayat</td></tr>`;
            }
        }

        async function viewTransactionDetail(txId) {
            const content = document.getElementById('history-detail-content');
            content.innerHTML = `<div class="p-10 text-center animate-pulse">Mengambil rincian...</div>`;
            document.getElementById('history-modal').classList.remove('hidden');

            try {
                // Get header
                const resTx = await fetch(`${SUPABASE_URL}/rest/v1/transaksi?id=eq.${txId}&select=*`, { headers: getHeaders() });
                const tx = (await resTx.json())[0];

                // Get details (joining manually since we fetch all products already)
                const resDetail = await fetch(`${SUPABASE_URL}/rest/v1/transaksi_detail?transaksi_id=eq.${txId}&select=*`, { headers: getHeaders() });
                const details = await resDetail.json();

                let html = `
                    <div class="bg-gray-50 p-4 rounded-2xl space-y-1">
                        <div class="flex justify-between"><span>Tgl:</span><span class="font-bold">${new Date(tx.tanggal).toLocaleString()}</span></div>
                        <div class="flex justify-between"><span>Plgn:</span><span class="font-bold">${tx.nama_pelanggan}</span></div>
                        <div class="flex justify-between"><span>Kasir:</span><span class="font-bold">${tx.user_email}</span></div>
                    </div>
                    <div class="space-y-3">
                        <p class="font-bold text-[10px] uppercase tracking-widest text-gray-400">Rincian Item:</p>
                        ${details.map(d => {
                            const p = allProducts.find(x => x.id === d.barang_id);
                            return `
                                <div class="flex justify-between items-start">
                                    <div>
                                        <p class="font-bold text-gray-800">${p ? p.nama : 'Produk Tidak Dikenal'}</p>
                                        <p class="text-xs text-gray-500">${d.qty} ${d.satuan_digunakan} x Rp ${Number(d.harga).toLocaleString()}</p>
                                    </div>
                                    <p class="font-bold">Rp ${Number(d.qty * d.harga).toLocaleString()}</p>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    <div class="border-t pt-3 flex justify-between items-center text-lg font-black text-blue-600">
                        <span>TOTAL</span>
                        <span>Rp ${Number(tx.total).toLocaleString()}</span>
                    </div>
                `;
                content.innerHTML = html;

                // Setup reprint button
                document.getElementById('reprint-btn').onclick = () => {
                    const info = {
                        date: new Date(tx.tanggal).toLocaleString('id-ID'),
                        kasir: tx.user_email?.split('@')[0],
                        customer: tx.nama_pelanggan,
                        total: tx.total,
                        cash: 0, // We don't save cash received in this schema, so set to 0 or total
                        change: 0,
                        items: details.map(d => {
                            const p = allProducts.find(x => x.id === d.barang_id);
                            return {
                                nama: p ? p.nama : 'N/A',
                                qty: d.qty,
                                unitName: d.satuan_digunakan,
                                price: d.harga
                            };
                        })
                    };
                    printReceipt(info);
                };

            } catch (err) {
                content.innerHTML = `<div class="p-10 text-center text-red-500">Gagal mengambil detail transaksi</div>`;
            }
        }

        function closeHistoryModal() { document.getElementById('history-modal').classList.add('hidden'); }

        // --- INVENTORY MANAGEMENT (ADMIN) ---
        document.getElementById('product-form').onsubmit = async (e) => {
            e.preventDefault();
            const id = document.getElementById('edit-id').value;
            const data = {
                nama: document.getElementById('p-nama').value,
                barcode: document.getElementById('p-barcode').value || null,
                stok: parseInt(document.getElementById('p-stok').value)
            };
            for(let i=1; i<=4; i++) {
                data[`satuan_${i}`] = document.getElementById(`p-satuan-${i}`).value || null;
                data[`harga_ecer_${i}`] = parseFloat(document.getElementById(`p-ecer-${i}`).value) || 0;
                data[`harga_grosir_${i}`] = parseFloat(document.getElementById(`p-grosir-${i}`).value) || 0;
            }

            const method = id ? 'PATCH' : 'POST';
            const url = id ? `${SUPABASE_URL}/rest/v1/barang?id=eq.${id}` : `${SUPABASE_URL}/rest/v1/barang`;
            const res = await fetch(url, { method, headers: getHeaders(), body: JSON.stringify(data) });
            
            if(res.ok) {
                resetForm();
                await getProducts();
                alert("Data barang berhasil diperbarui!");
            } else {
                alert("Gagal menyimpan data. Pastikan Barcode belum digunakan.");
            }
        };

        function renderInventoryTable() {
            const tbody = document.getElementById('inventory-table-body');
            tbody.innerHTML = allProducts.map(p => `
                <tr class="hover:bg-blue-50/30 transition">
                    <td class="p-5">
                        <div class="font-bold text-gray-800">${p.nama}</div>
                        <div class="text-[9px] text-gray-400 font-bold uppercase tracking-tighter">${p.barcode || 'TANPA BARCODE'}</div>
                    </td>
                    <td class="p-5 text-center font-black text-blue-600">${p.stok}</td>
                    <td class="p-5">
                        <div class="font-black text-gray-700">${p.satuan_1}</div>
                        <div class="text-[9px] text-gray-400">E: ${Number(p.harga_ecer_1).toLocaleString()} | G: ${Number(p.harga_grosir_1).toLocaleString()}</div>
                    </td>
                    <td class="p-5">
                        <div class="font-bold text-gray-700">${p.satuan_2 || '-'}</div>
                        <div class="text-[9px] text-gray-400">${p.satuan_2 ? 'E: ' + Number(p.harga_ecer_2).toLocaleString() : ''}</div>
                    </td>
                    <td class="p-5 text-center">
                        <button onclick="editItem(${p.id})" class="bg-blue-600 text-white px-4 py-2 rounded-xl text-[10px] font-black hover:bg-blue-700 transition shadow-md shadow-blue-100 uppercase tracking-widest">EDIT</button>
                    </td>
                </tr>`).join('');
        }

        function editItem(id) {
            const p = allProducts.find(x => x.id === id);
            document.getElementById('edit-id').value = p.id;
            document.getElementById('p-nama').value = p.nama;
            document.getElementById('p-barcode').value = p.barcode || "";
            document.getElementById('p-stok').value = p.stok;
            for(let i=1; i<=4; i++) {
                document.getElementById(`p-satuan-${i}`).value = p[`satuan_${i}`] || "";
                document.getElementById(`p-ecer-${i}`).value = p[`harga_ecer_${i}`] || 0;
                document.getElementById(`p-grosir-${i}`).value = p[`harga_grosir_${i}`] || 0;
            }
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function resetForm() {
            document.getElementById('product-form').reset();
            document.getElementById('edit-id').value = "";
        }

        checkAuth();
    </script>
</body>
</html>
