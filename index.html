<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LENSA KASIR - Central Database</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --primary: #2563eb; --danger: #ef4444; --success: #22c55e; --dark: #1e293b; }
        body { font-family: sans-serif; background: #f1f5f9; margin: 0; padding: 10px; }
        .container { max-width: 800px; margin: auto; background: white; padding: 15px; border-radius: 8px; }
        
        /* Login Admin Section */
        .admin-bar { background: #334155; color: white; padding: 10px; border-radius: 5px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }
        input, select { padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        
        /* UI Components */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9rem; }
        th, td { border-bottom: 1px solid #eee; padding: 10px; text-align: left; }
        .hidden { display: none !important; }
        .btn { padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer; color: white; font-weight: bold; }
        .btn-add { background: var(--primary); }
        .btn-danger { background: var(--danger); }
        
        /* Modal */
        .overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); display:none; z-index:99; }
        .modal { position: fixed; top:50%; left:50%; transform:translate(-50%, -50%); background:white; padding:20px; border-radius:8px; display:none; z-index:100; width:90%; max-width:400px; }
    </style>
</head>
<body>

<div class="container">
    <div class="admin-bar">
        <span id="adminStatus">Mode: Kasir (View Only)</span>
        <button id="btnLoginUI" class="btn" style="background: #475569;" onclick="showLogin()">Login Admin</button>
        <button id="btnLogoutUI" class="btn btn-danger hidden" onclick="handleLogout()">Logout</button>
    </div>

    <header style="text-align:center; margin-bottom:20px;">
        <h1 style="color:var(--primary); margin:0;">LENSA KASIR</h1>
        <p>Database Terpusat - Toko Kelontong</p>
    </header>

    <div id="adminPanel" class="hidden" style="background: #f8fafc; padding: 15px; border: 1px dashed var(--primary); margin-bottom: 20px;">
        <h3>üõ† Kelola Barang (Admin)</h3>
        <input type="text" id="newNama" placeholder="Nama Barang">
        <input type="number" id="newGrosir" placeholder="Harga Grosir">
        <input type="number" id="newEcer" placeholder="Harga Eceran">
        <input type="text" id="newSatuan" placeholder="Satuan (Pcs/Dus)">
        <button class="btn btn-add" onclick="addProduct()">Simpan Barang</button>
    </div>

    <h3>üì¶ Daftar Barang</h3>
    <div style="overflow-x:auto;">
        <table>
            <thead>
                <tr>
                    <th>Barang</th>
                    <th>Grosir</th>
                    <th>Ecer</th>
                    <th>Aksi</th>
                </tr>
            </thead>
            <tbody id="productList"></tbody>
        </table>
    </div>

    <hr>
    <h3>üõí Nota Transaksi</h3>
    <table id="cartTable">
        <thead><tr><th>Item</th><th>Qty</th><th>Subtotal</th><th></th></tr></thead>
        <tbody id="cartList"></tbody>
    </table>
    <h2 id="totalBayar" style="text-align:right; color:var(--primary);">Total: Rp 0</h2>
    <button class="btn" style="background:var(--dark); width:100%; padding:15px;" onclick="printThermal()">üñ®Ô∏è CETAK STRUK</button>
</div>

<div class="overlay" id="overlay"></div>
<div class="modal" id="loginModal">
    <h3>Login Admin</h3>
    <input type="email" id="email" placeholder="Email" style="width:90%; margin-bottom:10px;"><br>
    <input type="password" id="password" placeholder="Password" style="width:90%; margin-bottom:10px;"><br>
    <button class="btn btn-add" onclick="handleLogin()">Masuk</button>
    <button class="btn btn-danger" onclick="closeModal()">Batal</button>
</div>

<div class="modal" id="cartModal">
    <h3 id="mProdName">Barang</h3>
    <select id="mPriceType" style="width:100%; margin-bottom:10px;">
        <option value="eceran">Eceran</option>
        <option value="grosir">Grosir</option>
    </select>
    <input type="number" id="mQty" value="1" style="width:90%; margin-bottom:10px;">
    <button class="btn btn-add" style="width:100%;" onclick="addToCart()">Tambah ke Nota</button>
</div>

<script>
    const SUPABASE_URL = "https://aafacwvmzxzpyyxryuoc.supabase.co";
    const SUPABASE_KEY = "sb_publishable_ARHLAIm1BNBWUTGBqfX8zA_OYlZHB9-";
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let cart = [];
    let tempProduct = null;
    let isAdmin = false;

    // --- AUTH LOGIC ---
    async function handleLogin() {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const { data, error } = await supabase.auth.signInWithPassword({ email, password });
        
        if (error) alert("Login Gagal: " + error.message);
        else {
            checkUser();
            closeModal();
        }
    }

    async function handleLogout() {
        await supabase.auth.signOut();
        checkUser();
    }

    async function checkUser() {
        const { data: { user } } = await supabase.auth.getUser();
        if (user) {
            isAdmin = true;
            document.getElementById('adminStatus').innerText = "Mode: ADMIN (Full Access)";
            document.getElementById('adminPanel').classList.remove('hidden');
            document.getElementById('btnLoginUI').classList.add('hidden');
            document.getElementById('btnLogoutUI').classList.remove('hidden');
        } else {
            isAdmin = false;
            document.getElementById('adminStatus').innerText = "Mode: Kasir (View Only)";
            document.getElementById('adminPanel').classList.add('hidden');
            document.getElementById('btnLoginUI').classList.remove('hidden');
            document.getElementById('btnLogoutUI').classList.add('hidden');
        }
        fetchProducts();
    }

    // --- PRODUCT LOGIC ---
    async function fetchProducts() {
        const { data } = await supabase.from('products').select('*').order('nama');
        const list = document.getElementById('productList');
        list.innerHTML = '';
        data.forEach(p => {
            list.innerHTML += `
                <tr>
                    <td>${p.nama}<br><small>${p.satuan}</small></td>
                    <td>${p.harga_grosir}</td>
                    <td>${p.harga_eceran}</td>
                    <td>
                        <button class="btn btn-add" onclick='openCartModal(${JSON.stringify(p)})'>+</button>
                        ${isAdmin ? `<button class="btn btn-danger" onclick="deleteProduct(${p.id})">Hapus</button>` : ''}
                    </td>
                </tr>
            `;
        });
    }

    async function addProduct() {
        const item = {
            nama: document.getElementById('newNama').value,
            harga_grosir: parseInt(document.getElementById('newGrosir').value),
            harga_eceran: parseInt(document.getElementById('newEcer').value),
            satuan: document.getElementById('newSatuan').value
        };
        const { error } = await supabase.from('products').insert([item]);
        if (error) alert(error.message);
        else fetchProducts();
    }

    async function deleteProduct(id) {
        if(confirm("Hapus barang ini dari database pusat?")) {
            await supabase.from('products').delete().eq('id', id);
            fetchProducts();
        }
    }

    // --- UI LOGIC ---
    function showLogin() { 
        document.getElementById('loginModal').style.display = 'block'; 
        document.getElementById('overlay').style.display = 'block'; 
    }
    
    function openCartModal(p) {
        tempProduct = p;
        document.getElementById('mProdName').innerText = p.nama;
        document.getElementById('cartModal').style.display = 'block';
        document.getElementById('overlay').style.display = 'block';
    }

    function closeModal() {
        document.querySelectorAll('.modal, .overlay').forEach(el => el.style.display = 'none');
    }

    function addToCart() {
        const type = document.getElementById('mPriceType').value;
        const qty = parseInt(document.getElementById('mQty').value);
        const price = type === 'grosir' ? tempProduct.harga_grosir : tempProduct.harga_eceran;
        
        cart.push({ nama: tempProduct.nama, qty, price, subtotal: qty * price });
        renderCart();
        closeModal();
    }

    function renderCart() {
        const body = document.getElementById('cartList');
        body.innerHTML = '';
        let total = 0;
        cart.forEach((item, i) => {
            total += item.subtotal;
            body.innerHTML += `<tr><td>${item.nama}</td><td>${item.qty}</td><td>${item.subtotal}</td><td><button onclick="cart.splice(${i},1);renderCart()">x</button></td></tr>`;
        });
        document.getElementById('totalBayar').innerText = "Total: Rp " + total.toLocaleString();
    }

    function printThermal() {
        // Logika print sama seperti kode sebelumnya
        window.print();
    }

    // Init
    checkUser();
</script>
</body>
</html>
