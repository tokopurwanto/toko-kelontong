<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POS Lensa Toko - Kasir & Inventori</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @media print {
            body * { visibility: hidden; }
            #receipt-print, #receipt-print * { visibility: visible; }
            #receipt-print { 
                position: absolute; left: 0; top: 0; width: 58mm; 
                padding: 10px; background: white;
            }
        }
        .active-tab { border-bottom: 3px solid white; opacity: 1; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen font-sans text-slate-900">

    <!-- VIEW LOGIN -->
    <div id="view-login" class="min-h-screen flex items-center justify-center bg-indigo-700 p-4">
        <div class="bg-white p-8 rounded-3xl shadow-2xl w-full max-w-md">
            <div class="text-center mb-10">
                <h1 class="text-3xl font-black text-indigo-700 tracking-tighter uppercase italic">Lensa Toko</h1>
                <p class="text-slate-400 text-sm font-bold">Pintu Masuk Kasir & Admin</p>
            </div>
            <form id="login-form" class="space-y-4">
                <div>
                    <label class="block text-[10px] font-black text-slate-400 uppercase mb-1">Alamat Email</label>
                    <input type="email" id="login-email" required class="w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl outline-none focus:ring-2 focus:ring-indigo-400 transition" placeholder="contoh: kasir@lensa.toko">
                </div>
                <div>
                    <label class="block text-[10px] font-black text-slate-400 uppercase mb-1">Password</label>
                    <input type="password" id="login-password" required class="w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl outline-none focus:ring-2 focus:ring-indigo-400 transition" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>
                <button type="submit" id="btn-login" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-black py-4 rounded-2xl shadow-lg transition active:scale-95">
                    MASUK KE SISTEM
                </button>
            </form>
        </div>
    </div>

    <!-- VIEW UTAMA -->
    <div id="view-main" class="hidden">
        <header class="bg-indigo-700 text-white p-4 shadow-lg sticky top-0 z-50">
            <div class="container mx-auto flex justify-between items-center">
                <div class="flex items-center gap-4">
                    <h1 class="text-xl font-black tracking-tighter italic">LENSA TOKO</h1>
                    <nav class="flex gap-6 font-black text-[11px] uppercase ml-8 tracking-widest">
                        <button onclick="switchTab('kasir')" id="nav-kasir" class="active-tab pb-1">Kasir</button>
                        <button onclick="switchTab('stok')" id="nav-stok" class="hidden opacity-60 hover:opacity-100">Database Barang</button>
                    </nav>
                </div>
                <div class="flex items-center gap-4">
                    <button id="btn-connect-printer" onclick="connectBluetooth()" class="text-[9px] bg-emerald-500 hover:bg-emerald-600 px-3 py-2 rounded-xl font-black transition uppercase shadow-lg mr-2">
                        üîå Hubungkan Printer BT
                    </button>
                    <div class="text-right hidden sm:block">
                        <p id="user-display" class="text-[10px] font-black uppercase tracking-tighter"></p>
                    </div>
                    <button onclick="handleLogout()" class="text-[10px] bg-red-500 hover:bg-red-600 px-4 py-2 rounded-xl font-black transition uppercase shadow-lg shadow-red-900/20">Log Out</button>
                </div>
            </div>
        </header>

        <main class="container mx-auto p-4">
            <!-- SECTION KASIR -->
            <section id="section-kasir" class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-2">
                    <div class="bg-white p-4 rounded-3xl shadow-sm border mb-4">
                        <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                            <div class="flex-1 flex items-center bg-slate-100 p-2 rounded-2xl gap-3">
                                <div class="bg-white p-2 rounded-xl shadow-sm text-xl">üîç</div>
                                <input type="text" id="search-box" onkeyup="filterItems()" placeholder="Cari nama barang..." class="w-full bg-transparent border-none outline-none text-sm font-bold text-slate-600">
                            </div>
                            
                            <div class="flex bg-slate-100 p-1.5 rounded-2xl w-full md:w-auto">
                                <button onclick="setPriceMode('ecer')" id="mode-ecer" class="flex-1 md:w-32 py-2.5 rounded-xl font-black text-[10px] uppercase tracking-widest transition-all duration-300 bg-white shadow-md text-indigo-600 border border-slate-100">
                                    üë§ Eceran
                                </button>
                                <button onclick="setPriceMode('grosir')" id="mode-grosir" class="flex-1 md:w-32 py-2.5 rounded-xl font-black text-[10px] uppercase tracking-widest transition-all duration-300 text-slate-400 hover:text-slate-600">
                                    üì¶ Grosir
                                </button>
                            </div>
                        </div>
                    </div>

                    <div id="grid-produk" class="grid grid-cols-2 md:grid-cols-3 xl:grid-cols-4 gap-4"></div>
                </div>

                <!-- KERANJANG -->
                <div class="bg-white p-6 rounded-3xl shadow-xl border h-fit sticky top-24">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-black text-slate-800">Tagihan</h2>
                        <button onclick="clearCart()" class="text-[10px] bg-slate-100 text-slate-500 px-3 py-1 rounded-full font-black uppercase hover:bg-red-50 hover:text-red-500 transition">Reset</button>
                    </div>
                    <div id="cart-list" class="space-y-3 max-h-[350px] overflow-y-auto mb-6 pr-1 no-scrollbar"></div>
                    
                    <div class="border-t pt-6 space-y-4">
                        <div class="flex justify-between items-end">
                            <span class="text-slate-400 font-black text-[10px] uppercase">Total Akhir</span>
                            <span id="total-display" class="text-3xl font-black text-indigo-700 leading-none">Rp 0</span>
                        </div>
                        <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100">
                            <label class="text-[10px] font-black text-slate-400 uppercase block mb-2 tracking-widest">Uang Tunai</label>
                            <div class="flex items-center text-2xl font-black text-slate-700">
                                <span class="mr-2 opacity-30 text-lg">Rp</span>
                                <input type="number" id="input-bayar" onkeyup="calcChange()" class="w-full bg-transparent outline-none border-b-2 border-slate-200 focus:border-indigo-500 transition pb-1 font-mono" placeholder="0">
                            </div>
                            <div class="flex justify-between mt-4 font-bold">
                                <span class="text-[10px] uppercase text-slate-400">Kembalian</span>
                                <span id="change-display" class="text-emerald-600">Rp 0</span>
                            </div>
                        </div>
                        <button onclick="prosesTransaksi()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-black py-4 rounded-2xl shadow-lg transition active:scale-95">
                            <span>CETAK NOTA</span>
                        </button>
                    </div>
                </div>
            </section>

            <!-- SECTION STOK -->
            <section id="section-stok" class="hidden">
                <div class="bg-white rounded-3xl shadow-sm border overflow-hidden">
                    <div class="p-6 border-b flex justify-between items-center bg-slate-50/50">
                        <h2 class="text-xl font-black text-slate-800 uppercase italic">Master Data Barang</h2>
                        <button onclick="openModal()" class="bg-indigo-600 text-white px-6 py-3 rounded-2xl font-black hover:bg-indigo-700 transition">
                            <span>+ BARANG BARU</span>
                        </button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-slate-50 text-[10px] font-black text-slate-400 uppercase tracking-widest">
                                <tr>
                                    <th class="p-5">Barang</th>
                                    <th class="p-5">Stok</th>
                                    <th class="p-5">Ecer</th>
                                    <th class="p-5">Grosir</th>
                                    <th class="p-5 text-center">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="table-stok-body" class="divide-y divide-slate-100"></tbody>
                        </table>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- MODAL EDITOR BARANG -->
    <div id="modal-barang" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm hidden flex items-center justify-center p-4 z-[100]">
        <div class="bg-white w-full max-w-lg rounded-3xl shadow-2xl overflow-hidden">
            <div class="p-6 border-b flex justify-between items-center bg-slate-50">
                <h3 class="text-xl font-black text-slate-800">Formulir Barang</h3>
                <button onclick="closeModal()" class="text-slate-300 hover:text-slate-600">‚úï</button>
            </div>
            <form id="form-master" class="p-6 grid grid-cols-2 gap-4">
                <input type="hidden" id="f-id">
                <div class="col-span-2">
                    <label class="text-[10px] font-black uppercase text-slate-400 mb-1 block">Nama Produk</label>
                    <input type="text" id="f-nama" required class="w-full p-3 bg-slate-50 rounded-xl border-2 border-transparent focus:border-indigo-400 outline-none transition">
                </div>
                <div><label class="text-[10px] font-black uppercase text-slate-400 mb-1 block">Stok</label><input type="number" id="f-stok" required class="w-full p-3 bg-slate-50 rounded-xl outline-none"></div>
                <div><label class="text-[10px] font-black uppercase text-slate-400 mb-1 block">Satuan</label><input type="text" id="f-satuan" required class="w-full p-3 bg-slate-50 rounded-xl outline-none"></div>
                <div><label class="text-[10px] font-black uppercase text-slate-400 mb-1 block">Harga Ecer</label><input type="number" id="f-ecer" required class="w-full p-3 bg-slate-50 rounded-xl outline-none"></div>
                <div><label class="text-[10px] font-black uppercase text-slate-400 mb-1 block">Harga Grosir</label><input type="number" id="f-grosir" required class="w-full p-3 bg-slate-50 rounded-xl outline-none"></div>
                <div class="col-span-2 flex gap-4 mt-4">
                    <button type="button" onclick="closeModal()" class="flex-1 py-4 font-black text-slate-400 uppercase text-xs">Batal</button>
                    <button type="submit" class="flex-1 py-4 bg-indigo-600 text-white rounded-2xl font-black shadow-lg">Simpan</button>
                </div>
            </form>
        </div>
    </div>

    <!-- STRUK PRINT (SISTEM) -->
    <div id="receipt-print" class="hidden font-mono text-[10px]">
        <center><p class="font-bold text-xs">LENSA TOKO</p><p>----------------------------</p></center>
        <div id="print-items" class="my-2 space-y-1"></div>
        <p>----------------------------</p>
        <div class="flex justify-between font-bold text-xs"><span>TOTAL</span><span id="p-total"></span></div>
        <div class="flex justify-between"><span>TUNAI</span><span id="p-tunai"></span></div>
        <div class="flex justify-between"><span>KEMBALI</span><span id="p-kembali"></span></div>
        <p>----------------------------</p>
        <center><p id="p-tgl" class="mt-4 opacity-50"></p></center>
    </div>

    <script>
        const SB_URL = "https://aafacwvmzxzpyyxryuoc.supabase.co";
        const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFhZmFjd3Ztenh6cHl5eHJ5dW9jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU2NzI3NjMsImV4cCI6MjA4MTI0ODc2M30.A30SXHeEKM2k4qCzJTi67Ewo9PLALHjexD3cikBUwJs";
        const ADMIN_EMAIL = "admin@lensa.toko"; 

        let sessionToken = localStorage.getItem('sb_session_token') || "";
        let userEmail = localStorage.getItem('sb_user_email') || "";
        let masterBarang = [];
        let keranjang = [];
        let totalHarga = 0;
        let currentPriceMode = 'ecer';
        
        // Bluetooth Printer Variables
        let bluetoothCharacteristic = null;

        async function connectBluetooth() {
            try {
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ services: ['000018f0-0000-1000-8000-00805f9b34fb'] }], // UUID standar printer thermal
                    optionalServices: ['000018f0-0000-1000-8000-00805f9b34fb']
                });
                const server = await device.gatt.connect();
                const service = await server.getPrimaryService('000018f0-0000-1000-8000-00805f9b34fb');
                const characteristics = await service.getCharacteristics();
                bluetoothCharacteristic = characteristics[0];
                
                document.getElementById('btn-connect-printer').innerText = "‚úÖ BT Terhubung";
                document.getElementById('btn-connect-printer').classList.replace('bg-emerald-500', 'bg-indigo-500');
            } catch (err) {
                console.error(err);
                alert("Gagal terhubung ke Bluetooth Printer. Pastikan Bluetooth aktif.");
            }
        }

        async function sendToBluetooth(text) {
            if (!bluetoothCharacteristic) return false;
            const encoder = new TextEncoder();
            const data = encoder.encode(text + "\n\n\n"); // Tambah feed kertas
            await bluetoothCharacteristic.writeValue(data);
            return true;
        }

        document.getElementById('login-form').onsubmit = async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const res = await fetch(`${SB_URL}/auth/v1/token?grant_type=password`, {
                method: 'POST', headers: { "apikey": SB_KEY, "Content-Type": "application/json" },
                body: JSON.stringify({ email, password })
            });
            const data = await res.json();
            if (data.access_token) {
                sessionToken = data.access_token;
                userEmail = data.user.email;
                localStorage.setItem('sb_session_token', sessionToken);
                localStorage.setItem('sb_user_email', userEmail);
                initApp();
            } else { alert("Login Gagal!"); }
        };

        function handleLogout() { localStorage.clear(); location.reload(); }
        function getHeaders() { return { "apikey": SB_KEY, "Authorization": `Bearer ${sessionToken || SB_KEY}`, "Content-Type": "application/json", "Prefer": "return=representation" }; }

        async function initApp() {
            if (!sessionToken) {
                document.getElementById('view-login').classList.remove('hidden');
                document.getElementById('view-main').classList.add('hidden');
                return;
            }
            document.getElementById('view-login').classList.add('hidden');
            document.getElementById('view-main').classList.remove('hidden');
            const isAdmin = userEmail.toLowerCase() === ADMIN_EMAIL.toLowerCase();
            document.getElementById('user-display').innerText = userEmail;
            if (isAdmin) document.getElementById('nav-stok').classList.remove('hidden');
            
            const res = await fetch(`${SB_URL}/rest/v1/barang?select=*&order=nama.asc`, { headers: getHeaders() });
            masterBarang = await res.json();
            renderProduk();
            if (isAdmin) renderStok();
        }

        function setPriceMode(mode) {
            currentPriceMode = mode;
            const btnEcer = document.getElementById('mode-ecer');
            const btnGrosir = document.getElementById('mode-grosir');
            if (mode === 'ecer') {
                btnEcer.className = "flex-1 md:w-32 py-2.5 rounded-xl font-black text-[10px] uppercase tracking-widest transition-all bg-white shadow-md text-indigo-600 border border-slate-100";
                btnGrosir.className = "flex-1 md:w-32 py-2.5 rounded-xl font-black text-[10px] uppercase tracking-widest transition-all text-slate-400 hover:text-slate-600";
            } else {
                btnGrosir.className = "flex-1 md:w-32 py-2.5 rounded-xl font-black text-[10px] uppercase tracking-widest transition-all bg-white shadow-md text-amber-600 border border-slate-100";
                btnEcer.className = "flex-1 md:w-32 py-2.5 rounded-xl font-black text-[10px] uppercase tracking-widest transition-all text-slate-400 hover:text-slate-600";
            }
            renderProduk(document.getElementById('search-box').value);
        }

        function renderProduk(filter = "") {
            const container = document.getElementById('grid-produk');
            container.innerHTML = "";
            const filtered = masterBarang.filter(b => b.nama.toLowerCase().includes(filter.toLowerCase()));
            filtered.forEach(b => {
                const isOutOfStock = b.stok <= 0;
                const hargaTampil = currentPriceMode === 'ecer' ? b.harga_ecer : b.harga_grosir;
                const modeColor = currentPriceMode === 'ecer' ? 'text-indigo-600' : 'text-amber-600';
                container.innerHTML += `
                    <div onclick="${isOutOfStock ? '' : `addToCart(${b.id})`}" class="bg-white p-5 rounded-3xl shadow-sm border-2 border-transparent hover:border-indigo-600 cursor-pointer transition-all active:scale-95 group relative">
                        <p class="text-[9px] font-black text-slate-300 uppercase mb-1">${b.satuan}</p>
                        <h3 class="font-bold text-slate-800 truncate">${b.nama}</h3>
                        <p class="${modeColor} font-black text-lg">Rp ${Number(hargaTampil).toLocaleString()}</p>
                        <span class="text-[9px] font-black px-2 py-1 rounded-lg bg-slate-50">Stok: ${b.stok}</span>
                    </div>
                `;
            });
        }

        function addToCart(id) {
            const produk = masterBarang.find(p => p.id === id);
            const item = keranjang.find(k => k.id === id && k.tipe === currentPriceMode);
            if (item) {
                if (item.qty < produk.stok) item.qty++;
                else alert("Stok habis!");
            } else {
                keranjang.push({ ...produk, qty: 1, tipe: currentPriceMode });
            }
            renderCart();
        }

        function renderCart() {
            const list = document.getElementById('cart-list');
            list.innerHTML = "";
            totalHarga = 0;
            keranjang.forEach(item => {
                const harga = item.tipe === 'grosir' ? item.harga_grosir : item.harga_ecer;
                const sub = harga * item.qty;
                totalHarga += sub;
                list.innerHTML += `
                    <div class="bg-slate-50 p-4 rounded-3xl border border-slate-100 flex justify-between items-center">
                        <div>
                            <p class="font-bold text-slate-800 text-sm">${item.nama}</p>
                            <p class="text-[8px] font-black uppercase text-indigo-500">${item.tipe} x ${item.qty}</p>
                        </div>
                        <p class="font-black text-indigo-700">Rp ${sub.toLocaleString()}</p>
                    </div>
                `;
            });
            document.getElementById('total-display').innerText = `Rp ${totalHarga.toLocaleString()}`;
        }

        async function prosesTransaksi() {
            const bayar = document.getElementById('input-bayar').value;
            if (keranjang.length === 0 || bayar < totalHarga) return alert("Cek input!");

            try {
                const res = await fetch(`${SB_URL}/rest/v1/transaksi`, { method: 'POST', headers: getHeaders(), body: JSON.stringify({ total: totalHarga }) });
                const head = await res.json();
                const tid = head[0].id;
                
                let rawText = "LENSA TOKO\n----------\n";
                for (const item of keranjang) {
                    const h = item.tipe === 'grosir' ? item.harga_grosir : item.harga_ecer;
                    rawText += `${item.nama}\n${item.qty} x ${h} = ${item.qty * h}\n`;
                    await fetch(`${SB_URL}/rest/v1/transaksi_detail`, { method: 'POST', headers: getHeaders(), body: JSON.stringify({ transaksi_id: tid, barang_id: item.id, qty: item.qty, harga: h }) });
                    await fetch(`${SB_URL}/rest/v1/barang?id=eq.${item.id}`, { method: 'PATCH', headers: getHeaders(), body: JSON.stringify({ stok: item.stok - item.qty }) });
                }
                rawText += `----------\nTOTAL: ${totalHarga}\nTUNAI: ${bayar}\nKEMBALI: ${bayar - totalHarga}\n\nTerima Kasih!`;

                // Coba kirim ke Bluetooth dulu, jika tidak ada/gagal, gunakan window.print()
                const btSuccess = await sendToBluetooth(rawText);
                if (!btSuccess) {
                    printReceiptLegacy(bayar);
                }

                clearCart();
                initApp();
            } catch (e) {
                alert("Gagal memproses transaksi.");
            }
        }

        function printReceiptLegacy(bayar) {
            const p = document.getElementById('print-items'); p.innerHTML = "";
            keranjang.forEach(i => {
                const h = i.tipe === 'grosir' ? i.harga_grosir : i.harga_ecer;
                p.innerHTML += `<div class="flex justify-between"><span>${i.nama}</span><span>${(i.qty * h).toLocaleString()}</span></div>`;
            });
            document.getElementById('p-total').innerText = totalHarga.toLocaleString();
            document.getElementById('p-tunai').innerText = Number(bayar).toLocaleString();
            document.getElementById('p-kembali').innerText = (bayar - totalHarga).toLocaleString();
            document.getElementById('p-tgl').innerText = new Date().toLocaleString();
            window.print();
        }

        function clearCart() { keranjang = []; renderCart(); document.getElementById('input-bayar').value = ""; }
        function filterItems() { renderProduk(document.getElementById('search-box').value); }
        function calcChange() { 
            const s = (document.getElementById('input-bayar').value || 0) - totalHarga;
            document.getElementById('change-display').innerText = `Rp ${Math.abs(s).toLocaleString()}`;
        }

        function switchTab(tab) {
            document.getElementById('section-kasir').classList.toggle('hidden', tab !== 'kasir');
            document.getElementById('section-stok').classList.toggle('hidden', tab !== 'stok');
        }

        window.onload = initApp;
    </script>
</body>
</html>
